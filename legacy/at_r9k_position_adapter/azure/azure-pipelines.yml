# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
    - master

pool:
    vmImage: "ubuntu-latest"

steps:
    - task: NodeTool@0
      displayName: "Use Node.js 18"
      inputs:
          versionSpec: "18"

    # Install deps
    - task: Npm@1
      displayName: "Install dependencies"
      inputs:
          command: custom
          customCommand: ci
          verbose: true
          customEndpoint: "AT PHL Registry"

    # Run tests
    - task: Npm@1
      displayName: Run test
      inputs:
          command: custom
          verbose: true
          customCommand: run test

    # Publish Tests
    - task: PublishTestResults@2
      displayName: "Publish QA Results"
      inputs:
          testResultsFiles: "test-reports/**/*.xml"

    # NPM Build the project
    - task: Npm@1
      displayName: Compile
      inputs:
          command: custom
          verbose: true
          customCommand: run build

    # prepare artifacts for archiving
    - task: Npm@1
      displayName: Package artifact
      inputs:
          command: custom
          verbose: true
          customCommand: run package

    # Create artifact archive
    - task: ArchiveFiles@2
      displayName: "Create zip file"
      inputs:
          rootFolderOrFile: "artifact"
          includeRootFolder: false
          archiveType: "zip"
          archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.Repository.Name).$(Build.BuildId).zip"
          replaceExistingArchive: true

    #  Publish scripts that could be DB scripts or other required during deployment
    - task: CopyPublishBuildArtifacts@1
      displayName: "Publish Artifact Scripts"
      inputs:
          Contents: "scripts/**"
          ArtifactName: scripts
          ArtifactType: Container

    # Publish archive to 'drop' folder
    - task: CopyPublishBuildArtifacts@1
      displayName: "Publish build artifact from Azure Devops pipeline zip"
      inputs:
          CopyRoot: "$(Build.ArtifactStagingDirectory)"
          Contents: "*.zip"
          ArtifactName: drop
          ArtifactType: Container

    # Publish azure and parameters files to 'deploy' folder
    - task: CopyPublishBuildArtifacts@1
      displayName: "Publish Azure deploy"
      inputs:
          Contents: |
              parameters/azuredeploy*.json
              parameters/parameters-*.json
          ArtifactName: deploy
          ArtifactType: Container
