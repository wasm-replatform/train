name: realtime

services:
  train:
    image: ghcr.io/credibil/realtime:latest
    env_file: .env
    ports:
      - 8080:8080
    command: ["/train.wasm"]
    volumes:
      - ./target/wasm32-wasip2/release/train.wasm:/train.wasm
    depends_on:
      - kafka-topics
      - redis
      - otelcol

  kafka-topics:
    image: apache/kafka:latest
    command: |
      sh -c '
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:29092 --create --if-not-exists --topic dev-realtime-r9k.v1;
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:29092 --create --if-not-exists --topic dev-realtime-dilax-apc.v1;
      '
    depends_on:
      kafka:
        condition: service_healthy

  kafka:
    extends:
      file: oci://ghcr.io/credibil/compose-resources:latest
      service: kafka

  redis:
    extends:
      file: oci://ghcr.io/credibil/compose-resources:latest
      service: redis

include:
  - oci://ghcr.io/credibil/compose-opentelemetry:latest
